# BioinfAlgo

## HW1
```markdown
hw1/
├── src/
│   ├── __init__.py
│   ├── sequence_processing.py  # обработка последовательностей
│   └── chimera_generator.py    # генерация химерной последовательности
│   └── hmm.py                  # определение модели HMM
│   └── viterbi.py              # логика запуска Витерби
├── run_chimera.py          # запуск всего пайплайна 
├── run_viterbi.py          # запук Витерби с готовыми параметрами HMM
├── config.yaml             # конфигурационный файл для запуска всего пайплайна
└── config_viterbi.yaml     # конфигурационный файл для запуска Витерби
```

### Генерация химеры
Файл `run_chimera.py` содержит основную логику домашней работы:
1. **Процессинг файлов с последовательностями**: или `fasta`-файлов, или из `.txt`. В любом случае в последовательности остаются только нуклеотиды, указанные в конфигурационном файле (`hw1/config.yaml`). По умолчанию - **A**, **T**, **G**, **C**
2. **Генерация химерной последовательности** из процессированных последовательностей из п.1. Длина последовательности и средняя длина фрагмента указываются в конфигурационном файле. По умолчанию средняя длина фрагмента - 300 н., длина последовательности - 10 т.н.
3. **Построение HMM-модели** - определение матрицы эмиссий и переходов. 
    - Матрица переходов создается таким образом, что среднее число шагов в каждом из состояний равно средней длине фрагмента. 
    - Матрица эмиссий создается таким образом, что вероятность эмиссии для пиримидинов равна усредненной частоте пиримидинов в соответствующей последовательности. Аналогично для пуринов.
    - Изначальное стационарное состояние ищется как собственный вектор матрицы переходов, соответствующий собственному значению 1. При равномерном выборе последовательностей в генерации химерной последовательности, стационарное состояние также будет равномерным.
4. **Витерби-алгоритм**: поиск наиболее вероятного пути, с помощью которого была сгенерирована химерная последовательность. 

**Выполнение кода через CLI:**
```bash
python hw1/run_chimera.py --seq1 <path_to_seq1> --seq2 <path_to_seq2> --config <path_to_config>
```

Выполняется из корня проекта!
- `--seq1` - указывается путь к первой последовательности, из фрагментов которой будет генерироваться химерная последовательность. Формат `fasta` или `txt`.
- `--seq2` - указывается путь ко второй последовательности, из фрагментов которой будет генерироваться химерная последовательность. Формат `fasta` или `txt`.
- `--config` - указываетя путь к конфигурационному файлу. Пример в данном репозитории находится по относительному пути `hw1/config.yaml`


**Пример конфигурационного файла:**

```yaml
GeneralParams:
  num_sequences: 2
  valid_nucleotides: ['A', 'T', 'G', 'C']

ChimeraGenerator:
  mean_fragment_length: 300
  max_seqlen: 10000
  seed: 42
  param_folder: 'params'
  output_folder: 'data'
  output_name: 'chimera_seq'
  save_format: 'fasta'
```

- `mean_fragment_length` - средняя длина фрагмента. Длина фрагмента генерируется из экспоненциального распределения с заданным средним. По умолчанию - 300 н.
- `max_seqlen` - длина выходной химерной последовательности. По умолчанию - 10 тысяч н.
- `seed` - для воспроизводимости результатов. 
- `output_folder` - название папки, в которую будет сохранена:
    - Сгенерированная химерная последовательность - с названием `<output_name>.<save_format>`. Возможны два формата сохранения: `fasta` (по умолчанию) и `txt`
    - Метки для каждого нуклеотида: из какой последовательности (`seq1` или `seq2`) он пришел. Это последовательность длиной `max_seqlen`, состоящая из **1** и **2** (в зависимости от того, соответствует нуклеотид фрагменту из `seq1` или `seq2 `). Сохраняется с названием `<output_name>_states.txt`
- `param_folder` - папка, куда будет сохранена матрица эмиссий из HMM (название `emission_matrix.npy`). 

**Результат работы программы**
- Файл с химерной последовательностью. Сохраняется в папке `output_folder`, с названием `<output_name>.<save_format>`
- Файл с маппингом нуклеотидов химерной последовательности и их состояниями (из каких последовательностей пришли). Сохраняется в папке `output_folder`, с названием `<output_name>_states.txt`
- Файл с маппингом нуклеотидов химерной последовательности и их **предсказанными** Витерби состояниями. Сохраняется в папке `output_folder`, с названием `<output_name>_states_viterbi.txt`
- **Матрица эмиссий**  - в `<param_folder>/emission_matrix.npy`
- **Саммари** - файл `<output_folder>/summary.txt` будет содержать:
    - **Информация о химерной последовательности**:
        - Изначальные частоты нуклеотидов в оригинальных последовательностях `seq1` и `seq2`. 
        - Частоты нуклеотидов в химерной последовательности
        - Сколько нуклеотидов (асболютно и отноительно в %) содержит химерная последовательности из оригинальных последоватестей
        - Средняя длина фрагмента в химерной последовательности
        - Количество фрагментов, из которых состоит химерная последовательность
    - **Информация о HMM**:
        - Матрица переходов
        - Матрица эмиссий
        - Стационарное распределение
    - **Качество лучшего пути, определенного Витерби**
        - Error rate - в какой доле позиций мы ошиблись в определении "источника" нуклеотида
        - Считается для химерной последовательности
        - Считается доверительный интервал для error rate для рандомных фрагментов из изначальных последовательностей: семплируем X фрагментов из каждой послдеовательности, для них определяем Витерби (по определенным ранее матрице эмиссий и перехов) -> считаем error rate -> так делаем X раз -> считаем дов интервал (перцентильный)


### Запуск Витерби
Можно проверить работу Витерби с готовыми матрицами переходов и эмиссий.
```bash
    python hw1/run_viterbi.py --seq <path_to_sequence>  --output <savepath_predited_states> --config <path_to_config>
```
Выполняется из корня проекта!
- `--seq` - указывается путь к последовательности, для которой хотите найти лучший путь состояний (Витерби), которыми была сгенерирована последовательность
- `--output` - путь к файлу, где будет сохранена последовательность состояний, которыми наиболее вероятно была сгенерирована входная последовательность `seq` с учетом параметров HMM из `hmm_params`

**Конфигурационный файл**:
```yaml
valid_nucleotides: ['A', 'T', 'G', 'C']  # order in emission matrix
mean_steps: 300
emission_matrix_path: 'hw1/params/emission_matrix.npy'
```

`emission_matrix_path` - соответствует `<param_folder>/emission_matrix.npy` из пробега первого кода. но можно написать и самому. для этого укажите матрицы эмиссий для наблюдений в порядке, соответствующим `valid_nucleotides` из вашего конфигурационного файла (по колонкам). По строчкам - в соответствующем порядке состояний. 

Матрица переходов генерируется исходя из того, что среднее число шагов равно `mean_steps`. 

Определенное Витерби наиболее вреоятная последовательность состояний, которой была сгенерирована последовательность, будет сохранена по пути: `output` (текстовый формат). Это будет последовательность **1** и **2**, соответствующих каждому *валидному* нуклеотиду из входной послдеовательности. 


